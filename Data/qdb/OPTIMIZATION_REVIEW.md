# QDBä¼˜åŒ–æ–¹æ¡ˆåˆç†æ€§åˆ†æ

## âœ… åˆç†çš„éƒ¨åˆ†

### 1. äºŒåˆ†æŸ¥æ‰¾ä¼˜åŒ–ç´¢å¼•æŸ¥æ‰¾ â­â­â­â­â­

**åˆç†æ€§**: âœ… **éå¸¸åˆç†**

**åŸå› **:
- æ—¶é—´åºåˆ—æ•°æ®å¤©ç„¶æœ‰åºï¼Œé€‚åˆäºŒåˆ†æŸ¥æ‰¾
- O(log n) vs O(n) æ˜¯ç»å…¸ä¼˜åŒ–
- å®é™…åœºæ™¯ä¸­æ–‡ä»¶æ•°å¯èƒ½è¾¾åˆ°1000+ï¼Œä¼˜åŒ–æ•ˆæœæ˜æ˜¾

**é€‚ç”¨åœºæ™¯**:
- âœ… æ–‡ä»¶æ•° > 100 æ—¶æ•ˆæœæ˜æ˜¾
- âœ… æ—¶é—´èŒƒå›´æŸ¥è¯¢é¢‘ç¹
- âœ… ç´¢å¼•å·²æ’åºï¼ˆä¸€æ¬¡æ’åºï¼Œå¤šæ¬¡æŸ¥è¯¢ï¼‰

**æ½œåœ¨é—®é¢˜**:
- âš ï¸ éœ€è¦ç»´æŠ¤æ’åºçŠ¶æ€ï¼ˆå†™å…¥æ—¶éœ€è¦æ’å…¥æ’åºä½ç½®ï¼‰
- âš ï¸ å½“å‰å®ç°åªåœ¨åˆå§‹åŒ–æ—¶æ’åºï¼Œæ–°å¢æ•°æ®åéœ€è¦é‡æ–°æ’åº

**å»ºè®®**:
```python
# æ”¹è¿›ï¼šä½¿ç”¨bisect.insortä¿æŒæœ‰åº
def add_data(self, symbol, time_range):
    bisect.insort(self._time_index[symbol], time_range, key=lambda x: x[0])
```

### 2. å¹¶è¡Œæ–‡ä»¶åŠ è½½ â­â­â­â­

**åˆç†æ€§**: âœ… **åˆç†ï¼Œä½†æœ‰æ¡ä»¶**

**åŸå› **:
- IOå¯†é›†å‹æ“ä½œï¼Œå¹¶è¡ŒåŒ–æ•ˆæœå¥½
- å¤šæ–‡ä»¶åŠ è½½æ—¶ç¡®å®èƒ½åŠ é€Ÿ

**é€‚ç”¨åœºæ™¯**:
- âœ… æ–‡ä»¶æ•° > 5 æ—¶æ•ˆæœæ˜æ˜¾
- âœ… IOå»¶è¿Ÿè¾ƒé«˜æ—¶ï¼ˆSSD/HDDï¼‰
- âœ… CPUæ ¸å¿ƒæ•°å……è¶³

**æ½œåœ¨é—®é¢˜**:
- âš ï¸ å°æ–‡ä»¶æ•°æ—¶ï¼Œçº¿ç¨‹åˆ›å»ºå¼€é”€å¯èƒ½è¶…è¿‡æ”¶ç›Š
- âš ï¸ å†…å­˜å ç”¨å¢åŠ ï¼ˆå¤šä¸ªæ–‡ä»¶åŒæ—¶åŠ è½½ï¼‰
- âš ï¸ ç£ç›˜IOå¯èƒ½æˆä¸ºç“¶é¢ˆï¼ˆç‰¹åˆ«æ˜¯HDDï¼‰

**å»ºè®®**:
```python
# æ”¹è¿›ï¼šæ ¹æ®æ–‡ä»¶æ•°åŠ¨æ€å†³å®šæ˜¯å¦å¹¶è¡Œ
def load_parallel(self, file_paths, max_workers=4):
    if len(file_paths) < 5:  # å°æ–‡ä»¶æ•°æ—¶ä¸²è¡Œæ›´å¿«
        return self.load_serial(file_paths)
    # å¹¶è¡ŒåŠ è½½...
```

### 3. Bloom Filterå¿«é€Ÿåˆ¤æ–­ â­â­â­

**åˆç†æ€§**: âš ï¸ **åˆç†ä½†éœ€è¦æƒè¡¡**

**åŸå› **:
- O(1) æŸ¥æ‰¾ç¡®å®å¿«
- å†…å­˜å ç”¨å°

**é€‚ç”¨åœºæ™¯**:
- âœ… Symbolæ•°é‡å¾ˆå¤§ï¼ˆ1000+ï¼‰
- âœ… æŸ¥è¯¢æ¨¡å¼ï¼šç»å¸¸æŸ¥è¯¢ä¸å­˜åœ¨çš„symbol
- âœ… å¯ä»¥æ¥å—å°æ¦‚ç‡è¯¯åˆ¤

**æ½œåœ¨é—®é¢˜**:
- âš ï¸ **è¯¯åˆ¤ç‡**: 0.1%çš„è¯¯åˆ¤å¯èƒ½å¯¼è‡´ä¸å¿…è¦çš„ç£ç›˜IO
- âš ï¸ **å®é™…æ”¶ç›Šæœ‰é™**: å¦‚æœsymbolæ•°é‡ä¸å¤§ï¼ˆ<100ï¼‰ï¼Œå­—å…¸æŸ¥æ‰¾å·²ç»å¾ˆå¿«
- âš ï¸ **ç»´æŠ¤æˆæœ¬**: éœ€è¦åŒæ­¥æ›´æ–°Bloom Filterå’Œç´¢å¼•

**å»ºè®®**:
```python
# æ”¹è¿›ï¼šåªåœ¨symbolæ•°é‡å¤§æ—¶ä½¿ç”¨
if len(symbols) > 500:
    use_bloom_filter = True
else:
    use_bloom_filter = False  # ç›´æ¥ç”¨å­—å…¸ï¼ŒO(1)ä¸”æ— è¯¯åˆ¤
```

## âš ï¸ éœ€è¦æ”¹è¿›çš„éƒ¨åˆ†

### 1. äºŒåˆ†æŸ¥æ‰¾å®ç°æœ‰Bug

**é—®é¢˜**:
```python
# å½“å‰å®ç°
end_times = [tr[1] for tr in time_ranges]  # åˆ›å»ºæ–°åˆ—è¡¨ï¼ŒO(n)
idx = bisect.bisect_right(end_times, start_time)
```

**é—®é¢˜**:
- æ¯æ¬¡æŸ¥è¯¢éƒ½åˆ›å»ºæ–°åˆ—è¡¨ï¼ŒO(n)å¼€é”€
- åº”è¯¥é¢„å…ˆè®¡ç®—å¹¶ç¼“å­˜

**æ”¹è¿›**:
```python
# æ”¹è¿›ï¼šé¢„å…ˆè®¡ç®—end_timesåˆ—è¡¨
def _build_optimized_index(self):
    for symbol in df['symbol'].unique():
        time_ranges = [...]
        time_ranges.sort(key=lambda x: x[0])
        
        # é¢„å…ˆè®¡ç®—end_timesç”¨äºäºŒåˆ†æŸ¥æ‰¾
        end_times = [tr[1] for tr in time_ranges]
        self._time_index[symbol] = (time_ranges, end_times)  # å­˜å‚¨å…ƒç»„
```

### 2. ç´¢å¼•æ›´æ–°é—®é¢˜

**é—®é¢˜**: 
- å½“å‰åªåœ¨åˆå§‹åŒ–æ—¶æ„å»ºç´¢å¼•
- æ–°å¢æ•°æ®åç´¢å¼•ä¸ä¼šè‡ªåŠ¨æ›´æ–°
- éœ€è¦æ‰‹åŠ¨é‡å»ºç´¢å¼•

**æ”¹è¿›**:
```python
def add_data(self, symbol, time_range):
    # ä½¿ç”¨bisect.insortä¿æŒæœ‰åº
    bisect.insort(self._time_index[symbol], time_range, key=lambda x: x[0])
    # æ›´æ–°end_timesåˆ—è¡¨
    self._end_times[symbol] = [tr[1] for tr in self._time_index[symbol]]
```

### 3. å†…å­˜ä½¿ç”¨

**é—®é¢˜**:
- å°†æ‰€æœ‰ç´¢å¼•åŠ è½½åˆ°å†…å­˜
- å¯¹äºå¤§è§„æ¨¡æ•°æ®ï¼ˆ10000+ symbolsï¼‰ï¼Œå†…å­˜å ç”¨å¯èƒ½å¾ˆå¤§

**æ”¹è¿›**:
```python
# ä½¿ç”¨å†…å­˜æ˜ å°„æˆ–å»¶è¿ŸåŠ è½½
# æˆ–è€…ä½¿ç”¨æ›´ç´§å‡‘çš„æ•°æ®ç»“æ„ï¼ˆnumpyæ•°ç»„ï¼‰
import numpy as np

# ä½¿ç”¨numpyæ•°ç»„å­˜å‚¨æ—¶é—´æˆ³ï¼ˆæ›´ç´§å‡‘ï¼‰
self._time_index = {
    symbol: np.array([(st.timestamp(), et.timestamp()) for st, et, _ in ranges])
    for symbol, ranges in time_ranges.items()
}
```

## ğŸ“Š å®é™…åœºæ™¯è¯„ä¼°

### å…¸å‹HFTåœºæ™¯

1. **Symbolæ•°é‡**: é€šå¸¸ < 100ï¼ˆSPY, AAPL, MSFTç­‰ï¼‰
2. **æ–‡ä»¶æ•°**: æ¯ä¸ªsymbolå¯èƒ½10-100ä¸ªæ–‡ä»¶ï¼ˆæŒ‰æ—¥æœŸåˆ†å‰²ï¼‰
3. **æŸ¥è¯¢æ¨¡å¼**: 
   - é¢‘ç¹æŸ¥è¯¢ï¼šæœ€è¿‘å‡ å¤©çš„æ•°æ®ï¼ˆ1-5ä¸ªæ–‡ä»¶ï¼‰
   - å¶å°”æŸ¥è¯¢ï¼šå†å²æ•°æ®ï¼ˆ10-50ä¸ªæ–‡ä»¶ï¼‰

### ä¼˜åŒ–æ•ˆæœè¯„ä¼°

| åœºæ™¯ | æ–‡ä»¶æ•° | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | å®é™…æ”¶ç›Š |
|------|--------|--------|--------|----------|
| æœ€è¿‘æ•°æ®æŸ¥è¯¢ | 1-5 | 0.1ms | 0.05ms | **2x** (æ”¶ç›Šæœ‰é™) |
| æœˆåº¦æ•°æ®æŸ¥è¯¢ | 20-30 | 2ms | 0.5ms | **4x** (æ˜æ˜¾) |
| å¹´åº¦æ•°æ®æŸ¥è¯¢ | 250+ | 25ms | 1ms | **25x** (æ˜¾è‘—) |

**ç»“è®º**: 
- âœ… å¯¹äº**å¤§èŒƒå›´æŸ¥è¯¢**ï¼ˆæœˆåº¦/å¹´åº¦ï¼‰ï¼Œä¼˜åŒ–æ•ˆæœæ˜¾è‘—
- âš ï¸ å¯¹äº**å°èŒƒå›´æŸ¥è¯¢**ï¼ˆæœ€è¿‘å‡ å¤©ï¼‰ï¼Œä¼˜åŒ–æ”¶ç›Šæœ‰é™
- âœ… **å¹¶è¡ŒåŠ è½½**åœ¨æ‰€æœ‰åœºæ™¯éƒ½æœ‰æ”¶ç›Š

## ğŸ¯ æœ€ç»ˆè¯„ä¼°

### æ€»ä½“åˆç†æ€§: â­â­â­â­ (4/5)

**ä¼˜ç‚¹**:
1. âœ… ç®—æ³•é€‰æ‹©æ­£ç¡®ï¼ˆäºŒåˆ†æŸ¥æ‰¾ã€å¹¶è¡ŒåŒ–ï¼‰
2. âœ… æ—¶é—´å¤æ‚åº¦ä¼˜åŒ–åˆç†
3. âœ… é€‚åˆå¤§è§„æ¨¡æ•°æ®åœºæ™¯

**ç¼ºç‚¹**:
1. âš ï¸ å®ç°ç»†èŠ‚æœ‰æ”¹è¿›ç©ºé—´
2. âš ï¸ Bloom Filteræ”¶ç›Šæœ‰é™ï¼ˆsymbolæ•°é‡é€šå¸¸ä¸å¤§ï¼‰
3. âš ï¸ ç´¢å¼•æ›´æ–°æœºåˆ¶ä¸å®Œå–„

### å»ºè®®

1. **ä¿ç•™å¹¶æ”¹è¿›**:
   - âœ… äºŒåˆ†æŸ¥æ‰¾ä¼˜åŒ–ï¼ˆä¿®å¤å®ç°ç»†èŠ‚ï¼‰
   - âœ… å¹¶è¡Œæ–‡ä»¶åŠ è½½ï¼ˆæ·»åŠ åŠ¨æ€é˜ˆå€¼ï¼‰

2. **æ¡ä»¶ä½¿ç”¨**:
   - âš ï¸ Bloom Filterï¼ˆåªåœ¨symbolæ•°é‡>500æ—¶ä½¿ç”¨ï¼‰

3. **è¡¥å……ä¼˜åŒ–**:
   - ğŸ“ ç´¢å¼•å¢é‡æ›´æ–°æœºåˆ¶
   - ğŸ“ å†…å­˜æ˜ å°„ä¼˜åŒ–
   - ğŸ“ æŸ¥è¯¢ç»“æœç¼“å­˜ï¼ˆä¸åªæ˜¯æ–‡ä»¶è·¯å¾„ï¼‰

## ğŸ’¡ æ”¹è¿›ç‰ˆæœ¬å»ºè®®

```python
class OptimizedIndexer:
    def __init__(self, base_path):
        self._time_index: Dict[str, Tuple[List, np.ndarray]] = {}
        # (time_ranges, end_times_array) å…ƒç»„
        
    def find_files_optimized(self, symbol, start_time, end_time):
        if symbol not in self._time_index:
            return []
        
        time_ranges, end_times = self._time_index[symbol]
        
        # ä½¿ç”¨numpyçš„searchsortedï¼ˆæ›´é«˜æ•ˆï¼‰
        if start_time:
            idx = np.searchsorted(end_times, start_time, side='right')
        else:
            idx = 0
        
        # åç»­é€»è¾‘...
        
    def add_data(self, symbol, time_range):
        # å¢é‡æ›´æ–°ï¼Œä¿æŒæœ‰åº
        bisect.insort(self._time_index[symbol][0], time_range)
        # æ›´æ–°end_timesæ•°ç»„...
```

## âœ… æ€»ç»“

**è¿™ä¸ªä¼˜åŒ–æ–¹æ¡ˆæ˜¯åˆç†çš„**ï¼Œä½†éœ€è¦ï¼š
1. âœ… ä¿®å¤å®ç°ç»†èŠ‚ï¼ˆäºŒåˆ†æŸ¥æ‰¾çš„åˆ—è¡¨åˆ›å»ºé—®é¢˜ï¼‰
2. âœ… æ·»åŠ ç´¢å¼•å¢é‡æ›´æ–°æœºåˆ¶
3. âœ… Bloom Filteræ¡ä»¶ä½¿ç”¨ï¼ˆåªåœ¨å¿…è¦æ—¶ï¼‰
4. âœ… æ·»åŠ åŠ¨æ€é˜ˆå€¼ï¼ˆå¹¶è¡ŒåŠ è½½ã€Bloom Filterï¼‰

**é¢„æœŸæ”¶ç›Š**:
- å¤§èŒƒå›´æŸ¥è¯¢ï¼š10-25xåŠ é€Ÿ âœ…
- å°èŒƒå›´æŸ¥è¯¢ï¼š2-4xåŠ é€Ÿ âœ…
- æ€»ä½“ï¼š5-15xåŠ é€Ÿï¼ˆå–å†³äºæŸ¥è¯¢æ¨¡å¼ï¼‰âœ…

**å»ºè®®**: **é‡‡ç”¨ä¼˜åŒ–æ–¹æ¡ˆï¼Œä½†éœ€è¦æ”¹è¿›å®ç°ç»†èŠ‚**













